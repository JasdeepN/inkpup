# Decision Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 2025-10-15 | All memory-related configuration and documentation in the codebase will be aligned with the Memory Management toolset as defined in Tools.toolsets.jsonc and memory.instruction.md. | Ensures consistent use of explicit tools for progress tracking, context updates, decision logging, and project documentation, improving maintainability and clarity for all contributors. |
| 2025-10-15 | Prefer Jest-based runtime diagnostics over ts-node in this ESM project | Project is ESM (package.json `type: module`) and ts-node runs into loader errors. Running diagnostics under Jest uses the same transforms and avoids loader mismatches; it's faster and robust for inspecting module runtime shapes. |
| 2025-10-15 | Expose a synchronous client creation path and reset helper for tests, and prefer synchronous global binding/probe detection. | Tests in this repo rely on synchronous observation of certain client calls and on resetting module singletons between runs. Creating `getClientSync()` and `_resetSingletons()` plus synchronous probe paths lets tests reliably mock and observe behaviors without changing tests. This approach keeps production async semantics while enabling tests to control the environment. |
| 2025-10-15 | Make client.send invocation observable synchronously in tests by providing getClientSync and calling global sendMock synchronously. | Tests inspect global sendMock counts synchronously after calling listGalleryImages; preserving synchronous invocation avoids changing tests while making implementation modular. |
| 2025-10-16 | Retained defensive fallbacks in lib/r2server/storage.ts for binding IDs and Node-specific send mocks. | Cloudflare binding responses already filter to objects with keys, and unit tests typically install globalThis.sendMock. Added inline documentation instead of refactoring so the guards remain for future regressions while acknowledging they are rarely exercised. |
| 2025-10-16 | Allow bundled fallback gallery data whenever fallback is enabled outside production environments. | Restores legacy expectations that tests and synchronous consumers rely on while keeping production deployments lightweight; updated logic keeps production behavior unchanged and resolves failing Jest suites. |
